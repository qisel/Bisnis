<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Margin Trading MT5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .input-glow:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6; /* focus:ring-blue-500 */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-5xl mx-auto bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-white">Kalkulator Margin & Simulasi Strategi</h1>
                    <p class="text-gray-400 mt-2">Untuk Kripto & Emas di MT5</p>
                </div>

                <!-- Input Form -->
                <form id="calculator-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Kolom Kiri -->
                    <div>
                        <label for="asset" class="block text-sm font-medium text-gray-300 mb-1">Aset</label>
                        <input type="text" id="asset" value="BTCUSD" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow" placeholder="Contoh: BTCUSD, XAUUSD">

                        <label for="lotSize" class="block text-sm font-medium text-gray-300 mb-1 mt-4">Ukuran Lot per Posisi</label>
                        <input type="number" id="lotSize" value="0.01" step="0.01" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                        
                        <label for="contractSize" class="block text-sm font-medium text-gray-300 mb-1 mt-4">Ukuran Kontrak</label>
                        <input type="number" id="contractSize" value="1" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                        <p class="text-xs text-gray-500 mt-1">Contoh: 1 untuk BTC, 100 untuk XAUUSD</p>
                    </div>
                    
                    <!-- Kolom Kanan -->
                    <div>
                        <label for="leverage" class="block text-sm font-medium text-gray-300 mb-1">Leverage</label>
                        <select id="leverage" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                            <option value="100">1:100</option>
                            <option value="200">1:200</option>
                            <option value="400">1:400</option>
                            <option value="500">1:500</option>
                        </select>

                        <label for="initialPrice" class="block text-sm font-medium text-gray-300 mb-1 mt-4">Harga Awal (Open Posisi Pertama)</label>
                        <input type="number" id="initialPrice" value="110000" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                        
                        <label for="step" class="block text-sm font-medium text-gray-300 mb-1 mt-4">Jarak Antar Posisi ($)</label>
                        <input type="number" id="step" value="1000" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                        <p class="text-xs text-gray-500 mt-1">Harga bergerak berapa $ untuk buka posisi baru</p>
                    </div>

                    <!-- Baris Bawah -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="maxLevels" class="block text-sm font-medium text-gray-300 mb-1">Jumlah Maksimal Posisi (Layer)</label>
                            <input type="number" id="maxLevels" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                        </div>
                        <div>
                             <label for="targetPrice" class="block text-sm font-medium text-gray-300 mb-1">Target Harga Kerugian</label>
                            <input type="number" id="targetPrice" value="120000" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white input-glow">
                            <p class="text-xs text-gray-500 mt-1">Harga jika skenario terburuk terjadi</p>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Strategi</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="strategy" value="sell" checked class="h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500">
                                <span class="ml-2 text-white">SELL (Harga Naik, Buka Posisi Sell Baru)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="strategy" value="buy" class="h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500">
                                <span class="ml-2 text-white">BUY (Harga Turun, Buka Posisi Buy Baru)</span>
                            </label>
                        </div>
                    </div>
                </form>

                <!-- Tombol Aksi -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="calculateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">
                        Hitung & Simulasikan
                    </button>
                    <button id="resetBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        Reset
                    </button>
                </div>
            </div>

            <!-- Hasil -->
            <div id="results-container" class="hidden bg-gray-800 p-6 sm:p-8 border-t border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Hasil Simulasi</h2>

                <!-- Ringkasan -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-gray-700 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Total Posisi</p>
                        <p id="totalPositions" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Total Lot</p>
                        <p id="totalLots" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Harga Rata-rata</p>
                        <p id="avgPrice" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="bg-orange-500/20 border border-orange-500 p-4 rounded-lg text-center">
                        <p class="text-sm text-orange-300">Total Margin Dibutuhkan</p>
                        <p id="requiredMargin" class="text-2xl font-bold text-white">-</p>
                    </div>
                    <div class="col-span-2 bg-red-900/50 border border-red-700 p-4 rounded-lg text-center">
                        <p class="text-sm text-red-300">Estimasi Total Kerugian (di Target Harga)</p>
                        <p id="floatingLoss" class="text-2xl font-bold text-white">-</p>
                    </div>
                </div>
                
                <!-- Detail Tabel -->
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-900/50 rounded-lg">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Layer</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Harga Buka</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Harga Rata-rata</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Margin Dibutuhkan</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Floating Loss</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Harga Rugi $1</th>
                            </tr>
                        </thead>
                        <tbody id="trade-log">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-4 text-center">
                    *Floating Loss dihitung berdasarkan Target Harga Kerugian. Harga Rugi $1 adalah harga pasar agar total kerugian menjadi $1.
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const resultsContainer = document.getElementById('results-container');
            const tradeLog = document.getElementById('trade-log');

            const strategyRadios = document.querySelectorAll('input[name="strategy"]');
            const targetPriceInput = document.getElementById('targetPrice');

            function updateTargetPriceSuggestion() {
                const strategy = document.querySelector('input[name="strategy"]:checked').value;
                if (strategy === 'sell') {
                    targetPriceInput.value = "120000";
                } else {
                    targetPriceInput.value = "102000";
                }
            }

            strategyRadios.forEach(radio => radio.addEventListener('change', updateTargetPriceSuggestion));

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            };
            
            const formatNumber = (value, decimals = 2) => {
                 return parseFloat(value).toFixed(decimals);
            }

            calculateBtn.addEventListener('click', () => {
                // Ambil semua nilai input
                const lotSize = parseFloat(document.getElementById('lotSize').value);
                const contractSize = parseFloat(document.getElementById('contractSize').value);
                const leverage = parseInt(document.getElementById('leverage').value);
                const initialPrice = parseFloat(document.getElementById('initialPrice').value);
                const step = parseFloat(document.getElementById('step').value);
                const maxLevels = parseInt(document.getElementById('maxLevels').value);
                const targetPrice = parseFloat(document.getElementById('targetPrice').value);
                const strategy = document.querySelector('input[name="strategy"]:checked').value;

                // Validasi input
                if (isNaN(lotSize) || isNaN(contractSize) || isNaN(leverage) || isNaN(initialPrice) || isNaN(step) || isNaN(maxLevels) || isNaN(targetPrice)) {
                    console.error("Input tidak valid");
                    return;
                }
                
                tradeLog.innerHTML = ''; // Kosongkan tabel hasil sebelumnya
                let totalLots = 0;
                let weightedPriceSum = 0;
                let lastAvgPrice = 0;
                let lastRequiredMargin = 0;
                let openPositions = [];
                let lastFloatingLoss = 0;

                for (let i = 1; i <= maxLevels; i++) {
                    let openPrice;
                    if (strategy === 'sell') {
                        openPrice = initialPrice + ((i - 1) * step);
                    } else {
                        openPrice = initialPrice - ((i - 1) * step);
                    }
                    openPositions.push(openPrice);

                    totalLots += lotSize;
                    weightedPriceSum += openPrice * lotSize;

                    const avgPrice = weightedPriceSum / totalLots;
                    const requiredMargin = (totalLots * contractSize * avgPrice) / leverage;
                    
                    // Hitung floating loss berdasarkan target price
                    let currentFloatingLoss = 0;
                    if (strategy === 'sell') {
                        openPositions.forEach(price => {
                           currentFloatingLoss += (price - targetPrice) * lotSize * contractSize;
                        });
                    } else { // strategy === 'buy'
                        openPositions.forEach(price => {
                           currentFloatingLoss += (targetPrice - price) * lotSize * contractSize;
                        });
                    }

                    // **BARU: Hitung harga untuk kerugian $1**
                    let priceForOneDollarLoss = 0;
                    const lossAmount = 1; // $1
                    if (strategy === 'sell') {
                        // marketPrice = avgPrice + (loss / (totalLots * contractSize))
                        priceForOneDollarLoss = avgPrice + (lossAmount / (totalLots * contractSize));
                    } else { // strategy === 'buy'
                        // marketPrice = avgPrice - (loss / (totalLots * contractSize))
                        priceForOneDollarLoss = avgPrice - (lossAmount / (totalLots * contractSize));
                    }


                    // Buat baris tabel baru
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/50 transition-colors';
                    row.innerHTML = `
                        <td class="p-3 whitespace-nowrap">${i}</td>
                        <td class="p-3 whitespace-nowrap">${formatCurrency(openPrice)}</td>
                        <td class="p-3 whitespace-nowrap">${formatCurrency(avgPrice)}</td>
                        <td class="p-3 whitespace-nowrap font-semibold text-orange-400">${formatCurrency(requiredMargin)}</td>
                        <td class="p-3 whitespace-nowrap font-semibold text-red-400">${formatCurrency(currentFloatingLoss)}</td>
                        <td class="p-3 whitespace-nowrap font-semibold text-cyan-400">${formatCurrency(priceForOneDollarLoss)}</td>
                    `;
                    tradeLog.appendChild(row);

                    // Simpan data terakhir untuk ringkasan
                    if (i === maxLevels) {
                        lastAvgPrice = avgPrice;
                        lastRequiredMargin = requiredMargin;
                        lastFloatingLoss = currentFloatingLoss;
                    }
                }
                
                // Update kartu ringkasan
                document.getElementById('totalPositions').textContent = maxLevels;
                document.getElementById('totalLots').textContent = formatNumber(totalLots, 2);
                document.getElementById('avgPrice').textContent = formatCurrency(lastAvgPrice);
                document.getElementById('requiredMargin').textContent = formatCurrency(lastRequiredMargin);
                document.getElementById('floatingLoss').textContent = formatCurrency(lastFloatingLoss);

                // Tampilkan hasil
                resultsContainer.classList.remove('hidden');
                resultsContainer.classList.add('fade-in');
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
            });

            resetBtn.addEventListener('click', () => {
                document.getElementById('calculator-form').reset();
                resultsContainer.classList.add('hidden');
                tradeLog.innerHTML = '';
                document.getElementById('totalPositions').textContent = '-';
                document.getElementById('totalLots').textContent = '-';
                document.getElementById('avgPrice').textContent = '-';
                document.getElementById('requiredMargin').textContent = '-';
                document.getElementById('floatingLoss').textContent = '-';
                updateTargetPriceSuggestion();
            });
        });
    </script>
</body>
</html>

